{{ $item := .item }}
{{ $page := .page }}
{{ $title := $item.Title | default "Untitled" }}
{{ $url := $item.RelPermalink }}
{{ with $item.Params.external_link }}
{{ $url = . }}
{{ end }}

{{ $status := $item.Params.status | default "" }}
{{ $year := "" }}
{{ if $item.Params.year }}
{{ $year = printf "%v" $item.Params.year }}
{{ else if not $item.Date.IsZero }}
{{ $year = $item.Date.Format "2006" }}
{{ end }}

{{ $meta := $status }}
{{ if and (eq $meta "") ($year) }}
{{ $meta = $year }}
{{ end }}

{{ $show_abstract := in (slice "working-papers" "work-in-progress" "publication" "research" "policy") $item.Section }}

{{ $raw := "" }}
{{ if $item.Params.abstract }}
{{ $raw = $item.Params.abstract }}
{{ else if $item.Params.summary }}
{{ $raw = $item.Params.summary }}
{{ else if $item.Summary }}
{{ $raw = $item.Summary }}
{{ end }}
{{ $summary := markdownify $raw | trim " \t\r\n" }}

{{ $author_slugs := $item.Params.authors | default (slice) }}
{{ $authors := slice }}
{{ range $author_slugs }}
{{ if ne . "admin" }}
{{ $page := site.GetPage (printf "authors/%s" .) }}
{{ $name := cond (ne $page nil) $page.Title . }}
{{ $authors = $authors | append $name }}
{{ end }}
{{ end }}
{{ $author_text := "" }}
{{ if gt (len $authors) 0 }}
{{ $author_text = delimit $authors ", " }}
{{ end }}


<li class="li-list-item">
  <div class="li-block">
    <div class="li-line">
      <div class="li-content-left">
        <a href="{{ $url }}" class="li-title-link"><span class="li-title">{{ $title }}</span></a>
        
        {{/* Publication Info */}}
        {{ if $item.Params.publication_short }}
        <div class="li-publication" style="font-size: 0.9rem; color: var(--muted); margin-top: 0.2rem;">
          {{ $item.Params.publication_short | markdownify }}
        </div>
        {{ else if $item.Params.publication }}
        <div class="li-publication" style="font-size: 0.9rem; color: var(--muted); margin-top: 0.2rem;">
          {{ $item.Params.publication | markdownify }}
        </div>
        {{ end }}

        {{ $author_names := slice }}
        {{ range $author_slugs }}
        {{ if ne . "admin" }}
        {{ $name := . }}
        {{ $page := site.GetPage (printf "authors/%s" .) }}
        {{ if $page }}
        {{ $name = $page.Title }}
        {{ end }}
        {{ $author_names = $author_names | append $name }}
        {{ end }}
        {{ end }}
        {{ if gt (len $author_names) 0 }}
        <span class="li-coauthors">with {{ delimit $author_names ", " }}</span>
        {{ end }}
      </div>

      <div class="li-content-right">
        <div class="btn-links">
          {{ if and $show_abstract (gt (len $summary) 0) }}
          {{ $abstractId := printf "abstract-%s" ($item.RelPermalink | md5) }}
          <a href="#" data-target="{{ $abstractId }}"
            class="btn btn-outline-primary btn-page-header btn-sm abstract-trigger">Abstract</a>
          {{ end }}

          {{ if $item.Params.url_pdf }}
          {{ $pdf := $item.Resources.GetMatch $item.Params.url_pdf }}
          {{ $pdfUrl := "" }}
          {{ if $pdf }}
          {{ $pdfUrl = $pdf.RelPermalink }}
          {{ else }}
          {{ $pdfUrl = $item.Params.url_pdf }}
          {{ end }}
          <a class="btn btn-outline-primary btn-page-header btn-sm" href="{{ $pdfUrl }}" target="_blank"
            rel="noopener">PDF</a>
          {{ end }}

          {{ if $item.Params.url_slides }}
          {{ $slides := $item.Resources.GetMatch $item.Params.url_slides }}
          {{ $slidesUrl := "" }}
          {{ if $slides }}
          {{ $slidesUrl = $slides.RelPermalink }}
          {{ else }}
          {{ $slidesUrl = $item.Params.url_slides }}
          {{ end }}
          <a class="btn btn-outline-primary btn-page-header btn-sm" href="{{ $slidesUrl }}" target="_blank"
            rel="noopener">Slides</a>
          {{ end }}
        </div>
        {{ with $meta }}<span class="li-meta">{{ . }}</span>{{ end }}
      </div>
    </div>

    {{ if and (not $show_abstract) $item.Summary }}
    <div class="li-summary">
      {{ $item.Summary }}
    </div>
    {{ end }}

    {{ if and $show_abstract (gt (len $summary) 0) }}
    {{ $abstractId := printf "abstract-%s" ($item.RelPermalink | md5) }}
    <div id="{{ $abstractId }}" class="li-abstract">
      {{ $processed := markdownify $raw }}
      {{ if gt (len $processed) 10 }}
      {{ $processed | safeHTML }}
      {{ else }}
      {{ $raw | safeHTML }}
      {{ end }}
    </div>
    {{ end }}
  </div>
</li>

<script>
  // Ensure we only attach the listener once
  if (!window.abstractToggleInitialized) {
    window.abstractToggleInitialized = true;
    document.addEventListener('DOMContentLoaded', function () {
      document.body.addEventListener('click', function (e) {
        if (e.target.matches('.abstract-trigger') || e.target.closest('.abstract-trigger')) {
          e.preventDefault();
          const trigger = e.target.matches('.abstract-trigger') ? e.target : e.target.closest('.abstract-trigger');
          const targetId = trigger.getAttribute('data-target');
          const target = document.getElementById(targetId);

          if (target) {
            if (target.style.display === 'none' || getComputedStyle(target).display === 'none') {
              target.style.display = 'block';
            } else {
              target.style.display = 'none';
            }
          }
        }
      });
    });
  }
</script>